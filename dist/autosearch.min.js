class AutoComplete{constructor(e){if(this.input=document.querySelector(e.el),this.hiddenInput=document.getElementById("id-field"),this.form=document.getElementById("autocomplete-wrapper"),this.threshold=e.threshold,this.query="",this.max_results=e.max_results,this.key=e.key,e.secondary_key?this.secondary_key=e.secondary_key:this.secondary_key="",e.jsonData&&!e.api_endpoint)this.dataObj=e.jsonData,this.init();else{if(!e.api_endpoint||e.jsonData)throw new Error("You must include either a dataObj or api_endpoint option, and not both.");this.fetchData(e.api_endpoint).then(e=>this.dataObj=e).then(this.init())}}async fetchData(e){return await fetch(e).then(e=>{if(!e.ok)throw new Error("Unable to retrieve the autocomplete data from the server.");return e}).then(e=>e.json())}search(e){const t=this.dataObj.filter(t=>new RegExp(""+e,"i").exec(t[this.key]+t[this.secondary_key]));return t.sort(()=>t.index)}appendToDOM(e){const t=document.createElement("ul");t.id="ulist",(e=e.slice(0,this.max_results)).forEach(e=>{const i=document.createElement("a");i.href="";const n=document.createElement("li");i.dataset.spotId=e.id,i.addEventListener("click",t=>{t.preventDefault(),this.hiddenInput.value=e.id,this.form.submit()}),n.innerText=`${e[this.key]}, ${e[this.secondary_key]}`,n.classList.add("ac-result"),t.appendChild(i).appendChild(n),n.focus()}),this.input.after(t),t.getElementsByTagName("a")[0].classList.add("active")}removeULfromDOM(){const e=document.getElementById("ulist");e&&e.remove()}incrementActiveItem(e,t){let i;for(let n=0;n<e.length;n++)if(e[n].classList.contains("active"))return e[n].classList.remove("active"),void("down"==t?(e[n]==e[e.length-1]?(i=e[0],i.classList.add("active")):(i=e[n].nextElementSibling,i.classList.add("active")),this.input.value=i.firstChild.innerText):"up"==t&&(e[n]==e[0]?(i=e[e.length-1],i.classList.add("active")):(i=e[n].previousElementSibling,i.classList.add("active")),this.input.value=i.firstChild.innerText))}init(){this.input.addEventListener("keydown",e=>{"ArrowRight"!=e.key&&"ArrowLeft"!=e.key&&"ArrowUp"!=e.key&&"ArrowDown"!=e.key&&"Enter"!=e.key&&this.removeULfromDOM();let t=this.input.value+e.key;if("Backspace"==e.key&&(t=t.replace("Backspace",""),t=t.substring(0,t.length-1)),t.length>=this.threshold){const e=this.search(t.toLowerCase());Array.isArray(e)&&e.length>0&&this.appendToDOM(e)}const i=document.getElementById("ulist");if(i)if("ArrowDown"==e.key){const e=i.getElementsByTagName("a");this.incrementActiveItem(e,"down")}else if("ArrowUp"==e.key){const e=i.getElementsByTagName("a");this.incrementActiveItem(e,"up")}if("Enter"==e.key){e.preventDefault();try{let e=document.getElementsByClassName("active")[0];this.hiddenInput.value=e.dataset.spotId,this.form.submit()}catch{this.removeULfromDOM();const e=document.createElement("ul");e.id="ulist";const t=document.createElement("a"),i=document.createElement("li");i.innerText="No results",e.appendChild(t).appendChild(i),this.input.after(e)}}}),this.form.onblur=this.removeULfromDOM;const e=this;this.input.onfocus=function(t){if(t.target.value.length>=this.threshold){const i=e.search(t.target.value.toLowerCase());Array.isArray(i)&&i.length>0&&e.appendToDOM(i)}}}}
